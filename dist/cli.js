#!/usr/bin/env node
"use strict";var k=Object.create;var m=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var p=(s,t)=>m(s,"name",{value:t,configurable:!0});var D=(s,t,c,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of O(t))!B.call(s,o)&&o!==c&&m(s,o,{get:()=>t[o],enumerable:!(n=q(t,o))||n.enumerable});return s};var E=(s,t,c)=>(c=s!=null?k(z(s)):{},D(t||!s||!s.__esModule?m(c,"default",{value:s,enumerable:!0}):c,s));var w=E(require("yargs")),x=require("yargs/helpers");var y="1.3.0";var f=require("@povio/scaffold");var e=require("colorette"),r=require("lodash");var d;(function(s){s.registered="registered",s.configured="configured",s.uninitialized="uninitialized",s.queued="queued",s.delegated="delegated",s.disabled="disabled",s.conforming="conforming",s.executed="executed",s.errored="errored"})(d||(d={}));function b(s){let t=s.verbose||s.debug,c=s.debug;return(n,o,i)=>{if(n==="message"&&["error","warning"].includes(i.type)){console.log((0,e.cyan)((0,r.padStart)(o.id,50)),i.type==="error"?(0,e.red)((0,r.padEnd)(`message:${i.type}`,13)):(0,e.blue)((0,r.padEnd)(i.type,13)),i.message),i.error&&console.error(i.error);return}else if(o.constructor.name==="Task"){if(n===d.queued||n===d.delegated){if(console.log((0,e.cyan)((0,r.padStart)(o.id,50)),(0,e.blue)((0,r.padEnd)(n,13)),(0,e.magenta)("request"in o?o.request.match:""),o.description),!t){let l=!1;for(let a of"messages"in o?o.messages.filter(g=>["info"].includes(g.type)):[])console.log((0,r.padStart)("\u2570\u2500\u2500\u2500",50),a.type==="error"?(0,e.red)((0,r.padEnd)(a.type,13)):(0,e.blue)((0,r.padEnd)(a.type,13)),a.message),l=!0;l&&console.log()}return}if(n===d.executed){if(console.log((0,e.cyan)((0,r.padStart)(o.id,50)),(0,e.blue)((0,r.padEnd)(n,13))),!t&&n===d.executed){let l=!1;for(let a of"messages"in o?o.messages.filter(g=>["info"].includes(g.type)):[])console.log((0,r.padStart)("\u2570\u2500\u2500\u2500",50),a.type==="error"?(0,e.red)((0,r.padEnd)(`type:${a.type}`,13)):(0,e.blue)((0,r.padEnd)(`type:${a.type}`,13)),a.message),l=!0;l&&console.log()}return}}if(t)switch(n){case d.registered:(c||!["Module","Executor","Handler","Request"].includes(o.constructor.name))&&console.log((0,e.dim)((0,r.padStart)(o.id,50)),c?(0,e.italic)((0,e.blue)((0,r.padEnd)(n,13))):(0,e.blue)((0,r.padEnd)(n,13)),"request"in o?(0,e.magenta)(o.request.match):"",(0,e.dim)(o.description||"[no description]"));break;case d.configured:if(!c)return;console.log((0,e.dim)((0,r.padStart)(o.id,50)),(0,e.italic)((0,e.blue)((0,r.padEnd)(n,13))),(0,e.dim)(JSON.stringify(i)));break;case d.queued:case d.delegated:case d.disabled:case d.conforming:case d.executed:case d.errored:case d.uninitialized:(c||!["Module","Request","Handler"].includes(o.constructor.name))&&console.log((0,e.dim)((0,r.padStart)(o.id,50)),(0,e.italic)((0,e.blue)((0,r.padEnd)(n,13))),(0,e.dim)(JSON.stringify(i)));break;case"message":["error","warning"].includes(i.type)||console.log((0,e.dim)((0,r.padStart)(o.id,50)),(0,e.blue)((0,r.padEnd)(`message:${i.type}`,13)),(0,e.dim)(i.message));break;default:console.log((0,e.dim)((0,r.padStart)(o.id,50)),(0,e.blue)((0,r.padEnd)(n,13)),(0,e.dim)(JSON.stringify(i)))}}}p(b,"scaffoldingLogger");var C=p(async()=>(process.stdin.setRawMode(!0),new Promise(s=>process.stdin.once("data",t=>{let c=[...t];c.length>0&&c[0]===3&&(console.log("^C"),process.exit(1)),process.stdin.setRawMode(!1),s()}))),"keypress"),h={command:"apply",describe:"apply scaffolding",builder:{cwd:{describe:"Root directory of the project",demandOption:!0,type:"string",default:process.cwd()},verbose:{describe:"Verbose output",type:"boolean",default:!1},debug:{describe:"Debug output",type:"boolean",default:!1},yes:{describe:"Auto-apply",type:"boolean",default:!1}},handler:async s=>{try{let t=s.cwd,c=s.debug,n=s.verbose,o=s.yes,i=new f.Handler(t,b({verbose:n,debug:c}));for await(let l of(0,f.findScaffoldFiles)({cwd:t}))i.register(l);await i.init(),i.status==="queued"?(console.log(`Press any key to execute ${i.tasks.filter(l=>l.status==="queued").length} tasks:`),o||await C(),await i.exec(),process.exit(0)):console.log("No tasks to execute")}catch(t){console.error(t),process.exit(1)}}};(0,w.default)((0,x.hideBin)(process.argv)).version(y).scriptName("scaffold").command(h).help().demandCommand(1).strictCommands(!0).showHelpOnFail(!0).fail((s,t)=>{s&&console.log(s),t&&console.error(t),console.log("Use '--help' for more info"),process.exit(1)}).parse();
