#!/usr/bin/env node
"use strict";var _=Object.create;var f=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var d=(i,t)=>f(i,"name",{value:t,configurable:!0});var E=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of k(t))!v.call(i,n)&&n!==e&&f(i,n,{get:()=>t[n],enumerable:!(r=b(t,n))||r.enumerable});return i};var z=(i,t,e)=>(e=i!=null?_(q(i)):{},E(t||!i||!i.__esModule?f(e,"default",{value:i,enumerable:!0}):e,i));var x=z(require("yargs")),w=require("yargs/helpers");var m="1.3.0";var h=require("@povio/scaffold");var s=require("colorette"),o=require("lodash");var a;(function(i){i.registered="registered",i.configured="configured",i.uninitialized="uninitialized",i.queued="queued",i.delegated="delegated",i.disabled="disabled",i.conforming="conforming",i.executed="executed",i.errored="errored"})(a||(a={}));var u=class{static{d(this,"Task")}handler;executor;request;constructor(t,e,r,n){this.handler=e,this.executor=r,this.request=n,this._status=a.uninitialized,this.messages=[],this.priority=r.priority+n.priority/1e3,this.id=e.makeId(`${this.request.module.id}:task`),this.handler.onEvent(a.registered,this)}id;get description(){switch(!0){case!!this.request.description:return this.request.description;case!!this.executor.description:return this.executor.description;case!!this.executor.module.description:return`${this.executor.module.description}`;default:return`match:${this.executor.match}`}}async runInit(t){if(this.executor.init)try{await this.executor.init(this,{...t,addMessage:(...e)=>this.addMessage(...e)}),this.status===a.uninitialized&&(this.status=this.executor.exec?a.queued:a.conforming)}catch(e){if(this.status=a.errored,this.addMessage("error","Error while task init",e),this.executor.exception==="throw")throw e}}async runExec(t){if(!this.executor.exec)throw new Error("No exec function defined");try{await this.executor.exec(this,{...t,addMessage:(...e)=>this.addMessage(...e)}),this.status===a.queued&&(this.status=a.executed)}catch(e){if(this.status=a.errored,this.addMessage("error","Error while task exec",e),this.executor.exception==="throw")throw e}}_status;get status(){return this._status}set status(t){this._status!==t&&(this._status=t,this.handler.onEvent("status",this,t))}messages;addMessage(t,e,r){let n={type:t,message:e,error:r,status:this.status};return this.messages.push(n),this.handler.onEvent("message",this,n),n}priority;data};function p(i){return(t,e,r)=>{if(t===a.errored){console.error((0,s.cyan)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(t,13)),r);return}if(t==="message"&&["error","warning"].includes(r.type)){console.log((0,s.cyan)((0,o.padStart)(e.id,50)),r.type==="error"?(0,s.red)((0,o.padEnd)(r.type,13)):(0,s.blue)((0,o.padEnd)(r.type,13)),r.message),r.error&&console.error(r.error);return}else if(e instanceof u){if(t==="status"&&["queued","delegated"].includes(r)){if(console.log((0,s.cyan)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(r,13)),(0,s.magenta)(e.request.match),e.description),!i.verbose){let n=!1;for(let c of e.messages.filter(g=>["info"].includes(g.type)))console.log((0,o.padStart)("\u2570\u2500\u2500\u2500",50),c.type==="error"?(0,s.red)((0,o.padEnd)(c.type,13)):(0,s.blue)((0,o.padEnd)(c.type,13)),c.message),n=!0;n&&console.log()}return}if(t==="status"&&["executed","registered"].includes(r)){if(console.log((0,s.cyan)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(r,13))),!i.verbose&&r==="executed"){let n=!1;for(let c of e.messages.filter(g=>["info"].includes(g.type)))console.log((0,o.padStart)("\u2570\u2500\u2500\u2500",50),c.type==="error"?(0,s.red)((0,o.padEnd)(c.type,13)):(0,s.blue)((0,o.padEnd)(c.type,13)),c.message),n=!0;n&&console.log()}return}}if(i.verbose)switch(t){case a.registered:console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(t,13)),"request"in e?(0,s.magenta)(e.request.match):"",(0,s.dim)(e.description||"[no description]"));break;case"message":["error","warning"].includes(r.type)||console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(r.type,13)),(0,s.dim)(r.message));break;case"configured":case"queued":case"delegated":case"disabled":case"conforming":case"executed":case"uninitialized":console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(t,13)),(0,s.dim)(r));break;case"status":if(["queued"].includes(r)){console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(r,13)));return}else console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(r,13)));break;default:console.log((0,s.dim)((0,o.padStart)(e.id,50)),(0,s.blue)((0,o.padEnd)(t,13)),(0,s.dim)(JSON.stringify(r)))}}}d(p,"scaffoldingLogger");var B=d(async()=>(process.stdin.setRawMode(!0),new Promise(i=>process.stdin.once("data",()=>{process.stdin.setRawMode(!1),i()}))),"keypress"),y={command:"apply",describe:"apply scaffolding",builder:{cwd:{describe:"Root directory of the project",demandOption:!0,type:"string",default:process.cwd()},verbose:{describe:"Verbose output",type:"boolean",default:!1},yes:{describe:"Auto-apply",type:"boolean",default:!1}},handler:async i=>{try{let t=i.cwd,e=i.verbose,r=new h.Handler(t,p({verbose:e}));for await(let n of(0,h.findScaffoldFiles)({cwd:t}))r.register(n);await r.init(),r.status===h.Status.queued?(console.log(`Press any key to execute ${r.tasks.filter(n=>n.status===h.Status.queued)} tasks:`),await B(),await r.exec()):console.log("No tasks to execute")}catch(t){console.error(t),process.exit(1)}}};(0,x.default)((0,w.hideBin)(process.argv)).version(m).scriptName("scaffold").command(y).help().demandCommand(1).strictCommands(!0).showHelpOnFail(!0).fail((i,t)=>{i&&console.log(i),t&&console.error(t),console.log("Use '--help' for more info"),process.exit(1)}).parse();
